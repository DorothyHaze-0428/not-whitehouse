<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°é—»å›¾ç‰‡ç”Ÿæˆå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 20px auto;
            padding: 0 20px;
            max-width: 1918px;
            background: #f6f6f6;
            font-family: Arial, sans-serif;
        }

        .controls {
            margin: 25px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        button {
            padding: 12px 28px;
            margin: 0 10px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 16px;
        }

        button:hover {
            background: #1557b0;
        }

        input[type="file"] {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
        }

        #main-canvas {
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            background: white;
        }
    </style>
</head>
<body>
    <h1>NOT WHITE HOUSE ğŸ“°</h1>
    
    <div class="controls">
        <input type="file" id="image-upload" accept="image/*">
        <input type="text" id="title-input" placeholder="è¾“å…¥æ–°é—»æ ‡é¢˜" style="padding: 10px; width: 300px;">
        <button onclick="updateTitle()">æ›´æ–°æ ‡é¢˜</button>
        <button onclick="saveImage()">ä¿å­˜é«˜æ¸…å›¾ç‰‡</button>
    </div>

    <canvas id="main-canvas" width="1918" height="799"></canvas>

    <script>
        // ================= é…ç½®åŒº =================
        const CONFIG = {
            canvas: {
                width: 1918,
                height: 799,
                bgColor: '#ffffff'
            },
            
            background: {
                url: 'https://i.ibb.co/jvgnCNpz/20250309-002125.jpg'
            },
            
            image: {
                defaultScale: 0.5,  // åˆå§‹ç¼©æ”¾æ¯”ä¾‹
                minScale: 0.2,      // æœ€å°ç¼©æ”¾
                maxScale: 1.5       // æœ€å¤§ç¼©æ”¾
            },
            
            title: {
                defaultText: 'AMERICA IS BACK',
                position: { left: 360, top: 140 },
                style: {
                    fontSize: 92,
                    fill: '#ffffff',  // ç™½è‰²å­—ä½“
                    fontFamily: "'Libre Baskerville', serif",
                    fontWeight: 700,
                    width: 1000,
                    shadow: {
                        color: 'rgba(0,0,0,0.8)',  // æ·±è‰²é˜´å½±
                        offsetX: 2,
                        offsetY: 2,
                        blur: 4
                    },
                    textBackgroundColor: 'rgba(0,0,0,0.3)'  // åŠé€æ˜èƒŒæ™¯
                }
            }
        };

        // ================= åˆå§‹åŒ–ç”»å¸ƒ =================
        const canvas = new fabric.Canvas('main-canvas', {
            preserveObjectStacking: true,
            backgroundColor: CONFIG.canvas.bgColor
        });

        // åŠ è½½èƒŒæ™¯å›¾
        fabric.Image.fromURL(CONFIG.background.url, img => {
            img.set({
                scaleX: CONFIG.canvas.width / img.width,
                scaleY: CONFIG.canvas.height / img.height,
                selectable: false
            });
            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
        });

        // ================= æ ‡é¢˜ç³»ç»Ÿ =================
        const newsTitle = new fabric.Textbox(CONFIG.title.defaultText, {
            ...CONFIG.title.position,
            ...CONFIG.title.style,
            shadow: new fabric.Shadow(CONFIG.title.style.shadow),
            textBackgroundColor: CONFIG.title.style.textBackgroundColor
        });
        canvas.add(newsTitle);
        newsTitle.bringToFront();

        function updateTitle() {
            const newText = document.getElementById('title-input').value;
            if (newText) {
                newsTitle.set('text', newText.toUpperCase());
                canvas.requestRenderAll();
            }
        }

        // ================= å›¾ç‰‡ä¸Šä¼ å¤„ç† =================
        document.getElementById('image-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                // ç§»é™¤æ—§å›¾ç‰‡
                canvas.getObjects().forEach(obj => {
                    if (obj.isUploadedImage) canvas.remove(obj);
                });

                fabric.Image.fromURL(event.target.result, img => {
                    // è®¡ç®—åˆå§‹ç¼©æ”¾
                    const initScale = Math.min(
                        CONFIG.image.defaultScale,
                        (CONFIG.canvas.width * 0.8) / img.width,
                        (CONFIG.canvas.height * 0.8) / img.height
                    );

                    img.set({
                        left: CONFIG.canvas.width / 2,
                        top: CONFIG.canvas.height / 2,
                        scaleX: initScale,
                        scaleY: initScale,
                        originX: 'center',
                        originY: 'center',
                        isUploadedImage: true,
                        hasControls: true,
                        lockUniScaling: true,  // ä¿æŒå®½é«˜æ¯”
                        borderColor: '#1a73e8',
                        cornerColor: '#1a73e8',
                        cornerSize: 12,
                        transparentCorners: false
                    });

                    canvas.add(img);
                    img.sendToBack();
                    newsTitle.bringToFront();
                    canvas.requestRenderAll();
                });
            };
            reader.readAsDataURL(file);
        });

        // ================= ä¿å­˜å›¾ç‰‡åŠŸèƒ½ =================
        function saveImage() {
            // æ£€æŸ¥ç”»å¸ƒå†…å®¹
            if (canvas.getObjects().length === 0) {
                alert('ç”»å¸ƒä¸­æ²¡æœ‰å†…å®¹ï¼Œè¯·å…ˆä¸Šä¼ å›¾ç‰‡å¹¶æ·»åŠ æ ‡é¢˜');
                return;
            }

            // å–æ¶ˆé€‰ä¸­çŠ¶æ€
            canvas.discardActiveObject();
            
            // ä¿å­˜åŸå§‹ç¼©æ”¾çŠ¶æ€
            const originalZoom = canvas.getZoom();
            canvas.setZoom(1);  // é‡ç½®ç¼©æ”¾ä¿è¯è¾“å‡ºè´¨é‡
            
            // ç”Ÿæˆé«˜æ¸…å›¾ç‰‡
            const dataURL = canvas.toDataURL({
                format: 'png',
                quality: 1,
                multiplier: CONFIG.canvas.width / canvas.getWidth()
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const link = document.createElement('a');
            link.download = `news-image-${Date.now()}.png`;
            link.href = dataURL;
            
            // è§¦å‘ä¸‹è½½
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // æ¢å¤åŸå§‹çŠ¶æ€
            canvas.setZoom(originalZoom);
        }
    </script>
</body>
</html>